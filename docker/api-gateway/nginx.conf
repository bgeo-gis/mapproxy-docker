server {
    listen       80;
    server_name  localhost;

    client_max_body_size 50m;
    proxy_read_timeout 1d;
    proxy_connect_timeout 1d;
    proxy_send_timeout 1d;
    send_timeout 1d;

    proxy_redirect     off;
    proxy_set_header   host              $http_host;
    proxy_set_header   x-real-ip         $remote_addr;
    proxy_set_header   x-forwarded-for   $proxy_add_x_forwarded_for;
    proxy_set_header   x-forwarded-proto $scheme;

    # disables emitting nginx version on error pages and in the “server” response header field.
    # http://nginx.org/en/docs/http/ngx_http_core_module.html#server_tokens
    #
    server_tokens off;

    location ~ ^/mapproxy/(?<project>[^/]+)/wmts/tiles/(?<layer>[^/]+)/(?<layer_grid>[^/]+)/(?<z>\d+)/(?<x>\d+)/(?<y>\d+)\.(?<format>\w+)$ {
        # Pad coordinates to 9 digits
        set $padded_x "000000000$x";
        set $padded_y "000000000$y";
        set $padded_z "0$z";

        # Split into 3-digit groups using regex captures
        if ($padded_x ~ "(?<x1>\d{3})(?<x2>\d{3})(?<x3>\d{3})$") {}
        if ($padded_y ~ "(?<y1>\d{3})(?<y2>\d{3})(?<y3>\d{3})$") {}
        if ($padded_z ~ "(?<z>\d{2})$") {}

        alias "/srv/qwc_service/mapproxy/tiles/$project/${layer}_cache/${layer_grid}/$z/$x1/$x2/$x3/$y1/$y2/$y3.$format";

        error_page 404 = /mapproxy/blank.png;
    }

    # a simple handler for the blank tile request
    location = /mapproxy/blank.png {
        # internal;   # optional—prevents direct client requests if you like
        alias /srv/qwc_service/mapproxy/tiles/blank.png;
        add_header Content-Type image/png;
    }

    location ~ ^/mapproxy {
        proxy_set_header Host localhost; # Change this to the domain name of the server

        # rewrite ^/[^/]+(.+) $1 break;
        # proxy_set_header Host qwc2.example.com/$http_tenant/mapproxy_auth_proxy;

        proxy_set_header X-Forwarded-Proto https;
        proxy_pass http://mapproxy-bgeo:9090;
    }

}